# Generic Suite CodeGen

## Description

The Generic Suite CodeGen is a comprehensive Retrieval-Augmented Generation (RAG) AI system that generates starting application frontend and backend code, JSON configuration files, Python Langchain Tools, and Python MCP Tools for GenericSuite library-based projects, as described in the documentation website [https://genericsuite.carlosjramirez.com](https://genericsuite.carlosjramirez.com/) (which is stored in the [GenericSuite Basecamp repo](https://github.com/tomkat-cr/genericsuite-basecamp.git)), and allows the user to ask questions about that documentation (or knowledge base).

## Project Overview

We're building a simple Retrieval-Augmented Generation (RAG) AI agent using the Pydantic AI library. The agent will have access to a knowledge base stored in MongoDB Vector Search, allowing it to retrieve relevant information to answer user queries about the GenericSuite documentation, creates JSON configuration files, starting application frontend and backend code, and AI/MCP Tools code (written in Python) to be used with the GenericSuite library-based projects.

The system combines document ingestion, vector search, AI agent capabilities, and a user-friendly interface to help developers create configuration files and tools based on GenericSuite documentation and examples.

## Architecture

### Core Components:

1. **Document Ingestion Pipeline**
    - Being stored in the "document_processing" directory
    - Clone locally the Github repository `https://github.com/tomkat-cr/genericsuite-basecamp.git`
    - Read all the files in the repository:
      - Accepts local TXT files (specified in the [File Extensions to Include](#file-extensions-to-include) section), and PDF files
      - Don't accept files that are in the `.gitignore` files and in the [File Extensions to Exclude](#file-extensions-to-exclude)
    - Process all the accepted files into chunks
    - Simple text processing and chunking (without external libraries)
    - Generates embeddings using OpenAI or HuggingFace embedding models.
    - Stores documents and vectors in MongoDB Vector Search

2. **MongoDB Vector Search Database**
    - Being stored in the "server/genericsuite_codegen/database" directory
    - Store document chunks and their embeddings with pgvector
    - Support semantic search for efficient retrieval
    - Tables will be created and managed via MongoDB MCP server

3. **Pydantic AI Agent**
    - Being stored in the "server/genericsuite_codegen/agent" directory
    - Define a tool to query the knowledge base
    - Define a tool to generate JSON configuration files and AI/MCP Tools code
    - Use LiteLLM or OpenAI API models for generating responses
    - Integrates retrieved contexts into responses
    - Integrate knowledge base search results into responses

4. **ReactJS User Interface**
    - Being stored in the "ui" directory
    - Interface for update the embeddings of the knowledge base (deleting existings local repo files, deleting MongoDB vectors, cloning the repo, creating the repo files, generating the embeddings, and storing them in the MongoDB Vector Search)
    - Interface for uploading documents to be used on the user's queries
    - Interface for querying the Pydantic AI Agen (via the FastAPI API) to answer questions about the GenericSuite documentation or generate JSON files/Tools code
    - Display agent responses with source attribution and let the user have a conversation (asking more questions), and/or download the generated files.
    - Use ShadCn components (https://ui.shadcn.com)

5. **FastAPI API**
    - Being stored in the "server/genericsuite_codegen/api" directory
    - API for the Pydantic AI Agent
    - Define all the endpoints for the Pydantic AI Agent and the UI

6. **FastMCP MCP Server**
    - Being stored in the "mcp_server" directory
    - Has tools and resources for the Pydantic AI Agent

7. **Deploy Script**
    - Being stored in the "deploy" directory
    - Has a script to build and deploy the RAG agent to a Docker container
    - Has Dockerfile file for the RAG agent image
    - Has docker-compose.yml files that mounts the RAG agent code directory, local directory where the repository will be cloned as volumes, the python image generated by the Dockerfile, a local MongoDB database, etc.

### Technology Stack:

- **Language**: Python >- 3.12+ amd < 3.14
- **Poetry**: Poetry for Python dependency management
- **AI Framework**: Pydantic AI for agent implementation
- **Database**: MongoDB Vector Search with `pymongo` Python dependency
- **Embeddings**: OpenAI embeddings API and HuggingFace `sentence-transformers` (configurable by EMBEDDINGS_PROVIDER and EMBEDDINGS_MODEL envvars)
- **LLM Provider**: OpenAI API and LiteLLM for LLM integration (configurable LLM_API, LLM_PROVIDER, and LLM_MODEL envvars)
- **UI**: ReactJS, ShadCn, Vite
- **Document Processing**: Simple text processing with PyPDF2 for PDF extraction

## Project Structure

```
genericsuite-codegen/          # Main project directory
├── .env.example
├── README.md
├── Makefile
├── LICENSE
├── package.json              # Workspace manager (npm workspaces)
├── deploy/                   # Deployment configuration
│   ├── docker_images/
│   │   ├── Dockerfile
│   │   └── build_docker_images.sh
│   ├── docker-compose.yml
│   ├── nginx.conf
│   ├── run-deploy.sh
│   └── server-entrypoint.sh
├── local_repo_files/             # Temporary local repository files
│   └── .gitignore
├── mcp-server/                   # MCP Server (Python + FastMCP)
│   ├── .env.example
│   ├── Makefile
│   ├── package.json
│   ├── pyproject.toml
│   ├── requirements.txt
│   ├── mcp_server.py
│   ├── run_mcp_server.sh
│   └── tests/
│       └── test_mcp_server.py
├── server/                       # Server (Python + FastAPI)
│   ├── Makefile
│   ├── package.json
│   ├── pyproject.toml
│   ├── requirements.txt
│   └── genericsuite_codegen/     # GenericSuite CodeGen Package (Python + FastAPI)
│       ├── database/
│       │   └── setup.py          # Database setup and connection utilities
│       ├── api/
│       │   ├── __init__.py
│       │   ├── endpoint_methods.py
│       │   ├── utilities.py
│       │   ├── types.py
│       │   └── main .py          # FastAPI main file
│       ├── document_processing/
│       │   ├── __init__.py
│       │   ├── chunker.py        # Text chunking functionality
│       │   ├── embeddings.py     # Embeddings generation with OpenAI
│       │   ├── ingestion.py      # Document ingestion pipeline
│       │   └── processors.py     # TXT and PDF processing
│       ├── agent/
│       │   ├── __init__.py
│       │   ├── agent.py          # Main agent definition
│       │   ├── prompts.py        # System prompts
│       │   └── tools.py          # Knowledge base search tool
│       └── tests/
│           ├── test_chunker.py
│           ├── test_embeddings.py
│           ├── test_ingestion.py
│           ├── test_processors.py
│           └── test_agent.py
└── ui/                           # Frontend (React + Next.js)
    ├── .gitignore
    ├── components.json
    ├── Makefile
    ├── package.json
    ├── postcss.config.mjs
    ├── run-client.sh
    ├── tsconfig.json
    ├── vite.config.cjs
    ├── app/
    ├── components/
    ├── hooks/
    ├── lib/
    ├── pages/
    ├── public/
    ├── styles/
    └── tests/
```

## Development Process

The development will follow a task-based approach where each component will be implemented sequentially. We should:

1. Start by setting up the [project structure](#project-structure) and the [suggested files](#suggested-files)
2. Create [database tables](#database-tables) for the Vector Search using MongoDB MCP server
3. Implement simple document ingestion pipeline
4. Create the Pydantic AI agent with knowledge base search tool
5. Add the code and JSON files generation to the Pydantic AI agent
6. Prepare the starting application frontend and backend code (use the [Context7 MCP Server prompts](#context7-mcp-server-prompts)). This will allow to have the codebase for the users management, users login, etc.
7. Develop ReactJS UI
8. Connect all components and ensure they work together
9. Create the MCP Server from the FastMCP project endpoints
10. Test the complete system

## Design Principles

1. **Modularity**: Keep components decoupled for easier maintenance
2. **Simplicity**: Focus on making the system easy to understand and modify
3. **Performance**: Optimize for response time in knowledge retrieval
4. **User Experience**: Make the ReactJS interface intuitive
5. **Use Classes**: Use classes for better code organization and maintainability

## Environment Configuration

Create a `.env.example` file with the following variables:

- APP_DOMAIN_NAME: The domain name for the application. Defaults to `localhost`
- APP_NAME: The name of the application. Defaults to `GenericSuite CodeGen`

- MONGODB_URI: The MongoDB connection string. Defaults to `mongodb://root:example@mongo:27017/`
- REMOTE_REPO_URL: remote repository URL to be git-cloned. Defaults to `https://github.com/tomkat-cr/genericsuite-basecamp.git`
- LOCAL_REPO_DIR: The local directory where the repository will be cloned. Defaults to "/code/local_repo_files"

- HF_TOKEN: The HuggingFace API key
- OPENAI_API_KEY: The OpenAI API key

- LLM_API: The LLM API provider (e.g., "openai", "litellm"). Defaults to "litellm"
- LLM_PROVIDER: The LLM provider (e.g., "openai", "ollama", "anthropic", "vertexai", "bedrock"). Defaults to "ollama"
- LLM_MODEL: The LLM model (e.g., "gpt-5-nano"). Defaults to "gpt-oss-20b"
- LLM_TEMPERATURE: The llm temperature. Defaults to 0.5
- LLM_MAX_TOKENS: The llm max_tokens. Defaults to 2024
- LLM_TOP_P: The llm top_p. Defaults to 1.0
- LLM_TOP_K: The llm top_k. Defaults to 50

- EMBEDDINGS_PROVIDER: The embeddings provider (e.g., "openai", "huggingface"). Defaults to "huggingface"
- EMBEDDINGS_MODEL: The embeddings model (e.g., "text-embedding-3-small" for OpenAI, "thenlper/gte-small" for HuggingFace). Defaults to "thenlper/gte-small"

- SERVER_PORT: The port for the server. Defaults to 8000
- CORS_ORIGIN: The CORS origin for the server. Defaults to "localhost"
- SERVER_DEBUG: Whether to run the server in debug mode. Defaults to 0

- MCP_API_KEY: The MCP API Key . Defaults to "gs_codegen_pk-123"
- MCP_SERVER_PORT: The MCP port . Defaults to 8070
- MCP_SERVER_HOST: The MCP host IP address. Defaults to 0.0.0.0

- UI_PORT: The UI PORT. Defaults to 3000
- UI_SECURE_PORT: The UI SECURE_PORT. Defaults to 3001
- UI_APP_DOMAIN_NAME: The domain name. Defaults to localhost
- UI_API_BASE_URL: The UI API base URL. Defaults to localhost:8000
- UI_APP_SUBDIR: The UI APP_SUBDIR. Defaults to ""
- UI_DEBUG: The UI DEBUG. Defaults to 0

This file will serve as a template for users to create their own `.env` file.

## Expected Output

A functional RAG system where users can:
- Update the knowledge base by deleting existing local files, cloning the repository, creating the complete file list, generating embeddings, and storing them in MongoDB Vector Search
- Ask questions to the AI agent
- Receive responses that incorporate information from the knowledge base
- Generates JSON configuration files and AI/MCP Tools code
- Download generated files

## Notes

When implementing this project, make sure to:
- Mark tasks complete in the task.md file as you finish them
- For document processing, keep it simple using PyPDF2 for PDFs rather than complex document processing libraries
- Build a simple document ingestion pipeline without complex libraries
- Focus on creating a working Pydantic AI agent that can effectively retrieve and use information from the knowledge base, generate JSON files, Python and ReactJS code following the suggestions in the [Code Generation rules](#code-generation-rules) section
- Create a clean, intuitive ReactJS interface
- Use the Context7 MCP server to get updated documentation for all the technology stack components.
- Use the Brave MCP server to search the web for supplemental docs/examples to aid in creating the agent
- Isolate the endpoints code so it can be shared between FastAPI (the "server/api" code) and FastMCP (the "mcp-server" code).

## Code Generation rules

Follow these suggestions to generate JSON files, Python and ReactJS code:

- [JSON files for GenericSuite tables configuration](genericsuite-basecamp/docs/Sample-Code/exampleapp/apps/config_dbdef) following the [Generic CRUD Editor Configuration Documentation](genericsuite-basecamp/docs/Configuration-Guide/Generic-CRUD-Editor-Configuration.md)
- LangChain Tools following the [GenericSuite ExampleApp AI Agent](genericsuite-basecamp/docs/Sample-Code/exampleapp/apps/api-chalice/lib/models/ai_chatbot) application code examples
- Application frontend starting code from [ExampleApp UI](/Users/carlosramirez/desarrollo/mediabros_repos/github/genericsuite-basecamp/docs/Sample-Code/exampleapp/apps/ui)
- Application FastAPI backend starting code from [ExampleApp api-fastapi](/Users/carlosramirez/desarrollo/mediabros_repos/github/genericsuite-basecamp/docs/Sample-Code/exampleapp/apps/api-fastapi)
- Application Flask backend starting code from [ExampleApp api-flask](/Users/carlosramirez/desarrollo/mediabros_repos/github/genericsuite-basecamp/docs/Sample-Code/exampleapp/apps/api-flask)
- Application Chalice backend starting code from [ExampleApp api-chalice](/Users/carlosramirez/desarrollo/mediabros_repos/github/genericsuite-basecamp/docs/Sample-Code/exampleapp/apps/api-chalice)
- Application FastMCP MCP server starting code from [ExampleApp mcp-server](/Users/carlosramirez/desarrollo/mediabros_repos/github/genericsuite-basecamp/docs/Sample-Code/exampleapp/apps/mcp-server)

## Context7 MCP Server prompts

```
Using the Context7 MCP server, search for the "genericsuite basecamp" registered documentation and give me a frontend and backend monorepo for a application based on the genericsuite basecamp
```

## Database Tables

- `knowledge_base` - Stores the knowledge base documents and their embeddings
- `ai_chatbot_conversations` - Stores the user's conversations with the AI Agent
- `users` - Stores the registered Application users

## Database Table Structures

### `knowledge_base`

| Field | Type | Description |
| --- | --- | --- |
| id | int | Unique identifier for the document |
| path | text | The file path of the document |
| content | text | The content of the document |
| embedding | vector(1536) | The embedding vector of the document |

### `ai_chatbot_conversations`

| Field | Type | Description |
| --- | --- | --- |
| id | _id | Primary key identifier (auto-generated, readonly, hidden) |
| user_id | text | User identifier (required, readonly, hidden) |
| title | text | Conversation title (required, readonly, shown in listings) |
| creation_date | datetime-local | Timestamp when conversation was created (required, readonly, auto-generated, shown in listings) |
| update_date | datetime-local | Timestamp of last update (required, readonly, auto-generated, shown in listings, default sort field) |
| messages | array | Array containing conversation messages (required, readonly, not shown in listings) |

### `users`

| Field | Type | Description |
| --- | --- | --- |
| id | _id | Unique identifier for the user (required, readonly) |
| firstname | text | First Name of the user (required, shown in listings) |
| lastname | text | Last Name of the user (required, shown in listings) |
| email | email | Email address of the user (required, shown in listings) |
| status | select | Active status using TRUE_FALSE options (required, default: 1, shown in listings) |
| plan | select | Billing Plan using BILLING_PLANS options (required, default: 1, shown in listings) |
| superuser | select | Superuser privileges using TRUE_FALSE options (required, default: 0, shown in listings) |
| birthday | date | Birthday of the user (required) |
| gender | select | Gender using GENDERS options (required) |
| language | select | Preferred Language using LANGUAGES options (required) |
| creation_date | datetime-local | Timestamp when user was created (required, readonly, auto-generated, shown in listings) |
| update_date | datetime-local | Timestamp of last update (required, readonly, auto-generated) |
| passcode | password | New password field (optional, force empty value) |

...

## File Extensions to Include

### Configuration Files

.babelrc - Babel configuration
.cfg - Configuration files
.dockerignore - Docker ignore file
.env - Environment variables
.example - Example files
.gitignore - Git ignore file
.ini - Initialization files
.nvmrc - Node Version Manager
.npmrc - NPM configuration
.python-version - Python version specification
.toml - TOML configuration files
.yaml / .yml - YAML configuration files

### Code Files

.py - Python source files
.js - JavaScript files
.jsx - React JSX files
.ts - TypeScript files
.tsx - TypeScript JSX files
.mjs - ES6 module JavaScript
.cjs - CommonJS files
.hbs - Handlebars templates

### Web Assets

.html - HTML files
.css - Stylesheets

### Documentation

.md - Markdown files
.txt - Text files
.pdf - PDF documents

### Package Management

.json - JSON files (package.json, config files)

### Build/Development

.sh - Shell scripts
.sample - Sample files
.for_test - Test configuration files

## File Extensions to Exclude

### Web Assets

.svg - SVG vector graphics
.png - PNG images
.jpg - JPEG images
.ico - Icon files

### Documentation

.pptx - PowerPoint presentations

### Package Management

.lock - Lock files (package-lock.json, Pipfile.lock)

### Security/Certificates

.crt - Certificate files
.key - Private key files

### Build/Development

.bak - Backup files

### System Files

.DS_Store - macOS system files
.git - Git repository metadata

### Numbered Extensions
.0, .5, .10, .11, .12, .13 - Likely backup or versioned files

## Suggested Files

### Files for root directory

#### package.json

```json
{
  "name": "gscodegen_python",
  "version": "1.0.0",
  "description": "Generic Suite CodeGen"
  "private": true,
  "workspaces": [
    "server",
    "ui",
    "mcp-server"
  ],
  "scripts": {
    "dev": "concurrently -k \"npm:dev:*\"",
    "dev:server": "npm --workspace server run dev",
    "dev:ui": "npm --workspace ui run dev",
    "dev:mcp-server": "npm --workspace mcp-server run dev",
    "build": "npm -w ui run build:from_root",
    "build:all": "npm -w ui run build:from_root && npm -w server run build && npm -w mcp-server run build",
    "start": "npm -w server run start:from_root",
    "install:all": "npm install && npm -w mcp-server run api:install && npm -w server run api:install && npm -w ui install",
    "clean": "npm -w server run clean && npm -w ui run clean && npm -w mcp-server run clean && rm -rf node_modules"
  },
  "keywords": [
    "ai",
    "rag",
    "mcp",
    "mongodb",
    "vector-search",
    "fastapi",
    "nodejs",
    "codegen",
    "genericsuite"
  ],
  "author": "Carlos J. Ramirez",
  "license": "MIT",
  "devDependencies": {
    "concurrently": "^8.2.2"
  },
  "engines": {
    "node": ">=18.0.0",
    "npm": ">=8.0.0"
  }
}
```

#### Makefile

```
.PHONY: help up down restart logs build clean status

# Default target
help:
	cat Makefile

# Start all services
up:
	make build && cd deploy && make up && make logs-f

run: up

# Stop all services
down:
	cd deploy && make down

# Restart all services
restart:
	cd deploy && make restart

# Restart all services
hard-restart:
	make build && cd deploy && make down && make up && make logs-f

# Show logs
logs:
	cd deploy && make logs

# Follow logs
logs-f:
	cd deploy && make logs-f

# Clean up - stop services and remove volumes
clean-docker:
	cd deploy && docker compose down -v
	docker system prune -f
	@echo ""
	@echo "Done cleaning up"

# Show service status
status:
	docker compose ps

install:
	npm run install:all
	@echo ""
	@echo "Done installing"

build:
	npm run build
	@echo ""
	@echo "Done building"

start:
	npm run start

dev:
	npm run dev

clean:
	npm run clean
	@echo ""
	@echo "Done cleaning up"

list-scripts:
	npm run --workspace=server
	npm run --workspace=ui
	npm run --workspace=mcp-server

init-app-environment:
	bash ./scripts/init_app_environment.sh
	@echo ""
	@echo "Done initializing app environment"
```

### Files for "scripts" directory

#### scripts/init_app_environment.sh

```bash
#!/bin/bash
# scripts/init_app_environment.sh
# This script copies the .env.example file to the .env file,  as well as other example files to final/modficable files.
# It is used to initialize the environment for the application the first time it is run.

copy_env_example() {
    local source_env_file_path="$1"
    local target_env_file_path="$2"
    echo ""
    if [ ! -f "$source_env_file_path" ]; then
        echo "Error: Source environment file not found: $source_env_file_path"
        exit 1
    fi
    if [ -f "$target_env_file_path" ]; then
        echo "Target environment file already exists: $target_env_file_path"
        echo "Skipping..."
    else
        echo "Copying $source_env_file_path to $target_env_file_path" ...
        if ! cp "$source_env_file_path" "$target_env_file_path"; then
            echo "Error: Failed to copy $source_env_file_path to $target_env_file_path"
            exit 1
        fi
        echo "Done"
    fi
}

check_directories() {
    local directory_name="$1"
    if [ ! -d "$BASE_DIR/$directory_name" ]; then
        echo "Error: $directory_name directory not found: $BASE_DIR/$directory_name"
        exit 1
    fi
}

SCRIPT_DIR=$(dirname "$0")
BASE_DIR="$SCRIPT_DIR/.."

check_directories "deploy"

copy_env_example "$BASE_DIR/.env.example" "$BASE_DIR/.env"
copy_env_example "$BASE_DIR/deploy/nginx.conf.example" "$BASE_DIR/deploy/nginx.conf"
copy_env_example "$BASE_DIR/deploy/docker-compose.yml.example" "$BASE_DIR/deploy/docker-compose.yml"

```

### Files for "deploy" directory

#### deploy/Makefile

```
# Manages Docker Compose services for production deployment

.PHONY: help up down restart logs build clean status shell-server

# Default target
help:
	@echo "Deployment Commands:"
	@echo "  up          - Start all services"
	@echo "  down        - Stop all services"
	@echo "  restart     - Restart all services"
	@echo "  logs        - Show logs for all services"
	@echo "  logs-f      - Follow logs for all services"
	@echo "  build       - Build ui and start services"
	@echo "  clean       - Stop services and remove volumes"
	@echo "  status      - Show service status"
	@echo "  shell-server - Open shell in server container"

# Start all services
up:
	bash run-deploy.sh run

run: up

# Stop all services
down:
	bash run-deploy.sh down

# Restart all services
restart-docker:
	bash run-deploy.sh restart

# Restart all services
restart: restart-docker logs-f
	
# Show logs
logs:
	bash run-deploy.sh logs

# Follow logs
logs-f:
	bash run-deploy.sh logs-f

# Build ui and start services
build:
	@echo "Building ui..."
	cd ../ui && make build
	@echo "Starting services..."
	docker compose up -d

# Clean up - stop services and remove volumes
clean:
	docker compose down -v
	docker system prune -f

# Show service status
status:
	docker compose ps

# Open shell in server container
shell-server:
	docker compose exec gscodegen-server sh
```

#### deploy/run-deploy.sh

```bash
#!/bin/bash
# deploy/run-deploy.sh

load_envs() {
    if [ ! -f ../.env ]; then
        echo "Error: .env file not found in 'root' directory"
        exit 1
    fi
    echo "Loading environment variables from ../.env"
    set -o allexport; . ../.env; set +o allexport ;
}

start_up_function() {
    # Start up code
}

clean_up_function() {
    # Clean up code
}

create_docker_images() {
    echo "Creating docker images..."
    if ! sh ./docker_images/build_docker_images.sh
    then
        echo "Error creating docker images"
        exit 1
    fi
}

load_envs

APP_NAME_LOWERCASE=$(echo "$APP_NAME" | tr '[:upper:]' '[:lower:]')
APP_NAME_LOWERCASE=$(echo "$APP_NAME_LOWERCASE" | tr '[:blank:]' '_')

if [ -z "$APP_NAME_LOWERCASE" ];
    echo "ERROR: APP_NAME environment variable not set"
    exit 1
fi

ACTION=$1
if [ -z "$ACTION" ]; then
    echo "Error: No action specified"
    exit 1
fi
if [ "$ACTION" = "restart" ]; then
    echo "Restarting services..."
    docker compose --project-name ${APP_NAME_LOWERCASE} restart
    exit 0
elif [ "$ACTION" = "run" ]; then
    start_up_function
    echo "Starting services..."
    if ! docker network create my_shared_network
    then
        echo "my_shared_network already exists"
    fi
    docker compose --project-name ${APP_NAME_LOWERCASE} up -d
    exit 0
elif [ "$ACTION" = "down" ]; then
    echo "Stopping services..."
    if ! docker compose --project-name ${APP_NAME_LOWERCASE} down
    then
        echo "Error stopping services... skipping clean up function"
    fi
    clean_up_function
    exit 0
elif [ "$ACTION" = "logs" ]; then
    echo "Showing logs..."
    docker compose --project-name ${APP_NAME_LOWERCASE} logs
    exit 0
elif [ "$ACTION" = "logs-f" ]; then
    echo "Showing logs..."
    docker compose --project-name ${APP_NAME_LOWERCASE} logs -f
    exit 0
else
    echo "Error: Invalid action specified"
    exit 1
fi
```

#### deploy/server-entrypoint.sh

```bash
#!/bin/bash
# deploy/server-entrypoint.sh

load_envs() {
    set -e
    echo ""
    echo "Loading environment variables from /code/.env"
    sh /code/load_envs.sh /code/.env
}

run_server() {
    cd /code && uvicorn api.main:app --host 0.0.0.0 --port 8000 --env-file /code/.env
}

run_mcp_server() {
    cd /code/mcp-server && python mcp_server.py
}

load_envs
run_server & run_mcp_server & wait
```

#### deploy/nginx.conf.example

```nginx
# deploy/nginx.conf

server {
  listen 80;
  server_name _;

  root /usr/share/nginx/html;
  index index.html;

  location / {
    try_files $uri /index.html;
  }

  location /api/ {
    proxy_pass http://gscodegen-server:8000/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
    
    # CORS headers for API
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
    
    # Handle preflight requests
    if ($request_method = 'OPTIONS') {
      add_header 'Access-Control-Allow-Origin' '*';
      add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS';
      add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization';
      add_header 'Access-Control-Max-Age' 1728000;
      add_header 'Content-Type' 'text/plain; charset=utf-8';
      add_header 'Content-Length' 0;
      return 204;
    }
  }

  location /mcp {
    proxy_pass http://gscodegen-server:8070/mcp;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $http_connection;
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
    proxy_buffering off;
    proxy_request_buffering off;
  }

  access_log /var/log/nginx/access.log;
  error_log /var/log/nginx/error.log;
}
```

#### deploy/docker-compose.yml.example

```yaml
# deploy/docker-compose.yml

services:
  gscodegen-server:
    container_name: gscodegen-server
    image: gscodegen_python
    command: sh -c "bash /code/server-entrypoint.sh"
    volumes:
      - ../server/genericsuite_codegen:/code
      - ../server/genericsuite_codegen:/code/mcp-server/genericsuite_codegen
      - ../mcp-server:/code/mcp-server
      - ./server-entrypoint.sh:/code/server-entrypoint.sh
      - ./local_repo_files:/code/local_repo_files
    environment:
      # Server environment variables
      - SERVER_PORT=${SERVER_PORT:-8000}
      - CORS_ORIGIN=${CORS_ORIGIN}
      - APP_DOMAIN_NAME=${APP_DOMAIN_NAME}
      - APP_NAME=${APP_NAME}
      - SERVER_DEBUG=${SERVER_DEBUG}
      - MONGODB_URI=${MONGODB_URI}
      - REMOTE_REPO_URL=${REMOTE_REPO_URL}
      - LOCAL_REPO_DIR=${LOCAL_REPO_DIR}
      - HF_TOKEN=${HF_TOKEN}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - LLM_API=${LLM_MODEL}
      - LLM_PROVIDER=${LLM_MODEL}
      - LLM_MODEL=${LLM_MODEL}
      - LLM_TEMPERATURE=${LLM_TEMPERATURE}
      - LLM_MAX_TOKENS=${LLM_MAX_TOKENS}
      - LLM_TOP_P=${LLM_TOP_P}
      - LLM_TOP_K=${LLM_TOP_K}
      - EMBEDDINGS_PROVIDER=${EMBEDDINGS_PROVIDER}
      - EMBEDDINGS_MODEL=${EMBEDDINGS_MODEL}
      # MCP Server environment variables
      - MCP_API_KEY=${MCP_API_KEY}
      - MCP_SERVER_PORT=${MCP_SERVER_PORT:-8070}
      - MCP_SERVER_HOST=${MCP_SERVER_HOST:-0.0.0.0}
    ports: ["8000:8000", "8070:8070"]
    networks:
      - my_shared_network
    restart: unless-stopped

  gscodegen-client:
    container_name: gscodegen-client
    image: nginx:alpine
    volumes:
      - ../ui/dist:/usr/share/nginx/html:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    environment:
      - UI_PORT=${UI_PORT:-3000}
      - UI_SECURE_PORT=${UI_SECURE_PORT:-3001}
      - UI_APP_DOMAIN_NAME=${APP_DOMAIN_NAME}
      - UI_API_BASE_URL=${UI_API_BASE_URL}
      - UI_APP_SUBDIR=${UI_APP_SUBDIR}
      - UI_DEBUG=${UI_DEBUG}
    ports: ["3000:80", "3001:443"]
    depends_on: [gscodegen-server]
    networks:
      - my_shared_network
    restart: unless-stopped

  mongo:
    container_name: gscodegen-mongo-db
    image: mongo:latest
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: example
    ports:
      - 27017:27017
    expose:
      - 27017

  mongo-express:
    container_name: gscodegen-mongo-express
    image: mongo-express
    restart: unless-stopped
    ports:
      - 8081:8081
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: admin
      ME_CONFIG_MONGODB_ADMINPASSWORD: pass
      ME_CONFIG_MONGODB_URL: mongodb://root:example@mongo:27017/

networks:
  my_shared_network:
    external: true # Reference the same external network as the other services
```


#### deploy/docker_images/Dockerfile

```
# deploy/docker_images/Dockerfile

# Use an official Python runtime as a parent image
FROM python:3.12-slim

ARG OLLAMA_MODEL_NAME=gpt-oss-20b

# Set the working directory in the container
WORKDIR /code

RUN apt update && apt install -y curl

RUN pip install --upgrade pip

RUN pip install --no-cache-dir --upgrade \
    fastapi \
    uvicorn \
    python-multipart \
    litellm \
    fastmcp \
    pymongo \
    ollama \
    openai \
    pydantic-ai \
    PyPDF2 \
    numpy \
    pytest \
    pytest-asyncio \
    torch \
    transformers \
    sentence-transformers \
    faiss-cpu

RUN curl -fsSL https://ollama.com/install.sh | sh

RUN ollama pull "${OLLAMA_MODEL_NAME}"
```

#### deploy/docker_images/build_docker_images.sh

```bash
#!/bin/bash
# deploy/docker_images/build_docker_images.sh

BASE_DIR=$(pwd)
SCRIPT_DIR=$(cd $(dirname $0); pwd)

USE_BUILDX="${USE_BUILDX:-0}"
IMAGE_VERSION="${IMAGE_VERSION:-latest}"

run_build_cmd() {
    if [ "$USE_BUILDX" = "1" ]; then
        BUILD_CMD="docker buildx build --platform linux/amd64 --provenance=false -t $IMAGE_NAME:$IMAGE_VERSION -f $DOCKER_FILE ."
    else
        BUILD_CMD="docker build -t $IMAGE_NAME -f $DOCKER_FILE ."
    fi
    echo ""
    echo "Building $IMAGE_NAME:"
    echo "Using build command: $BUILD_CMD"
    echo ""
    if ! $BUILD_CMD
    then
        echo "Error building the '$IMAGE_NAME' image"
        echo "Failed command: $BUILD_CMD"
        exit 1
    fi
    echo "Built image: $IMAGE_NAME"
}

IMAGE_NAME="gscodegen_python"
DOCKER_FILE="Dockerfile"
run_build_cmd

echo ""
echo "Build completed"
echo ""
echo "To run the images, use the following commands:"
echo "docker run -d --name gscodegen_python gscodegen_python:$IMAGE_VERSION"

echo ""
echo "Done!"

cd $BASE_DIR
```

### Files for "server" directory

### server/Makefile

```
.PHONY: install build dev start clean test lint ssl-certs-creation

# Show help
help:
	@echo "Available commands:"
	@echo "  install    - Install npm dependencies"
	@echo "  dev        - Run server in development mode"
	@echo "  start      - Run server in production mode"
	@echo "  clean      - Remove node_modules and package-lock.json"
	@echo "  reinstall  - Clean and reinstall dependencies"
	@echo "  test       - Run tests"
	@echo "  lint       - Run linter"
	@echo "  help       - Show this help message"

# Install dependencies
install:
	poetry install

# Build the project (if needed for production)
build:
	poetry export -f requirements.txt --output requirements.txt --without-hashes

# Run in development mode with nodemon
dev:
	poetry run python api/main.py

run: dev

# Run in production mode
start:
	poetry run python api/main.py

# Clean node_modules and package-lock.json
clean:
	rm -rf .venv
	rm -rf __pycache__
	rm -rf .pytest_cache
	rm -rf .mypy_cache
	rm -rf .ruff_cache
	rm -rf .coverage
	rm -rf .coverage.*
	rm -rf .pytest_cache
	rm -rf .ruff_cache

# Reinstall dependencies
reinstall: clean install

# Run tests (when implemented)
test:
	poetry run pytest

# Run linter (when implemented)
lint:
	poetry run flake8

requirements: build
```

### server/package.json

```json
{
  "name": "server",
  "private": true,
  "version": "1.0.0",
  "type": "module",
  "main": "api/main.py",
  "scripts": {
    "dev": "make dev",
    "start": "make start",
    "clean": "make clean",
    "build": "make build",
    "api:install": "make install && make build"
  }
}
```


### server/pyproject.toml

```toml
[project]
name = "genericsuite-codegen"
version = "1.0.0"
description = "API for the GenericSuite CodeGen app"
authors = [
    {name = "Carlos J. Ramirez", email = "info@genericsuite.com"},
]
license = {text = "MIT"}
requires-python = ">=3.11,<3.14"
dependencies = [
    "fastapi (>=0.116.1,<0.117.0)",
    "transformers (>=4.55.3,<5.0.0)",
    "uvicorn (>=0.35.0,<0.36.0)",
    "python-multipart (>=0.0.20,<0.0.21)",
    "torch (>=2.8.0,<3.0.0)",
    "litellm (>=1.75.9,<2.0.0)",
    "safetensors (>=0.6.2,<0.7.0)",
]

[tool.poetry]
packages = [
    { include = "genericsuite_codegen" }
]

[build-system]
requires = ["poetry-core>=2.0.0,<3.0.0"]
build-backend = "poetry.core.masonry.api"
```

#### server/genericsuite_codegen/endpoint_methods.py

```python
import os
import base64
import json
from typing import Union


from .ai_models import AIModels
from .ml_models import MLModels
from .json_models import get_all_training_metrics
from .types import Article
from .utilities import (
    SERVER_DEBUG as DEBUG,
    remove_temp_file,
    get_temp_random_file_path,
    get_standard_response
)
from .dashboard_metrics import StaticDashboardMetrics
from .dashboard_metrics_from_db import DashboardMetricsFromDb

# Define all endpoints methods shared by the api and mcp-server
...
```

#### server/genericsuite_codegen/main.py

```python
import os
from typing import Optional

from fastapi import FastAPI, HTTPException, Body
from fastapi import UploadFile, File
from fastapi.responses import FileResponse
from fastapi.middleware.cors import CORSMiddleware

from .ai_models import AIModels
from .ml_models import MLModels
from .types import Metrics, Prediction, Article
from .dashboard_metrics import StaticDashboardMetrics
from .dashboard_metrics_from_db import DashboardMetricsFromDb
from .endpoint_methods import (
    ...
)
from .utilities import log_info

# Define all FastAPI endpoints
...
```

#### server/genericsuite_codegen/types.py

```python
from pydantic import BaseModel


# Define the request and response models
...
```

#### server/genericsuite_codegen/utilities.py

```python
import os
from datetime import datetime
from uuid import uuid4

SERVER_DEBUG = os.environ.get("SERVER_DEBUG", "0") == "1"


def remove_temp_file(file_path: str) -> None:
    """ Remove the temp file """
    os.remove(file_path)


def get_mime_type(filename: str) -> str:
    """ Get the mime type of the file """
    file_extension = os.path.splitext(filename)[1]
    if file_extension == '.pdf':
        return 'application/pdf'
    elif file_extension == '.txt':
        return 'text/plain'
    elif file_extension == '.docx':
        return ('application/vnd.openxmlformats-officedocument.'
                'wordprocessingml.document')
    elif file_extension == '.doc':
        return 'application/msword'
    elif file_extension == '.rtf':
        return 'text/rtf'
    elif file_extension == '.csv':
        return 'text/csv'
    else:
        return 'application/octet-stream'


def get_file_content(file_path: str) -> bytes:
    """ Get the content of the file """
    with open(file_path, 'rb') as f:
        return f.read()


def get_temp_random_file_path(file_name: str) -> str:
    """ Get the temp random file path """
    return os.path.join(
        '/tmp',
        f"{os.urandom(8).hex()}{'.'+get_file_extension(file_name)}")


def get_non_empty_value(env_var_name: str, default_value: str = None) -> str:
    """ Get the non empty value from the environment variable """
    resolved_value = os.environ.get(env_var_name)
    if resolved_value is None or resolved_value == "":
        resolved_value = default_value
    return resolved_value


def get_file_extension(file_path: str) -> str:
    """ Get the file extension """
    return os.path.splitext(file_path)[1].lstrip('.')


def get_file_name(filename: str) -> str:
    """ Get the file name """
    return os.path.basename(filename)


def get_file_id(filename: str) -> str:
    """ Get the file id """
    return get_uuid() + "." + get_file_extension(filename)


def get_uuid() -> str:
    """ Get the uuid """
    return str(uuid4())


def get_standard_response(
    error: bool = False,
    error_message: str = None,
    resultset: list = None,
    **kwargs,
):
    if not resultset:
        resultset = []
    return {
        "error": error,
        "error_message": error_message,
        "resultset": resultset,
        **kwargs
    }


def log_info(message: str):
    """
    Log information message
    """
    date_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    print(f"{date_time} - {message}")
```

### Files for "mcp-server" directory

#### mcp-server/Makefile

```
.PHONY: install build dev start clean test lint ssl-certs-creation

# Show help
help:
	@echo "Available commands:"
	@echo "  install    - Install npm dependencies"
	@echo "  dev        - Run server in development mode"
	@echo "  start      - Run server in production mode"
	@echo "  clean      - Remove node_modules and package-lock.json"
	@echo "  reinstall  - Clean and reinstall dependencies"
	@echo "  test       - Run tests"
	@echo "  lint       - Run linter"
	@echo "  help       - Show this help message"

# Install dependencies
install:
	poetry install

# Build the project (if needed for production)
build:
	poetry export -f requirements.txt --output requirements.txt --without-hashes

# Run in development mode with nodemon
dev: start_up
	bash ./run_mcp_server.sh

run: dev

start_up:
	bash ./link_common_assets.sh link

shut_down:
	bash ./link_common_assets.sh unlink

run-mcp-inspector: start_up
	MCP_INSPECTOR=1 bash ./run_mcp_server.sh

# Run in production mode
start:
	poetry run python mcp_server.py

# Clean node_modules and package-lock.json
clean:
	rm -rf .venv
	rm -rf lib
	rm -rf __pycache__
	rm -rf .pytest_cache
	rm -rf .mypy_cache
	rm -rf .ruff_cache
	rm -rf .coverage
	rm -rf .coverage.*
	rm -rf .pytest_cache
	rm -rf .ruff_cache

# Reinstall dependencies
reinstall: clean install

# Run tests (when implemented)
test:
	poetry run pytest

# Run linter (when implemented)
lint:
	poetry run flake8

requirements: build
```

### mcp-server/package.json

```json
{
  "name": "gscodegen-mcp-server",
  "private": true,
  "version": "1.0.0",
  "type": "module",
  "main": "mcp_server.py",
  "scripts": {
    "dev": "make dev",
    "start": "make start",
    "clean": "make clean",
    "build": "make build",
    "api:install": "make install && make build"
  }
}
```

### mcp-server/pyproject.toml

```toml
[project]
name = "mcp-server"
version = "1.0.0"
description = "MCP Server for the gscodegen app"
authors = [
    {name = "Carlos J. Ramirez", email = "info@genericsuite.com"},
]
license = {text = "MIT"}
requires-python = ">=3.11,<3.14"
dependencies = [
    "transformers (>=4.55.3,<5.0.0)",
    "python-multipart (>=0.0.20,<0.0.21)",
    "torch (>=2.8.0,<3.0.0)",
    "litellm (>=1.75.9,<2.0.0)",
    "safetensors (>=0.6.2,<0.7.0)",
    "fastmcp (>=2.11.3,<3.0.0)",
]

[tool.poetry]

[build-system]
requires = ["poetry-core>=2.0.0,<3.0.0"]
build-backend = "poetry.core.masonry.api"
```

#### mcp-server/run_mcp_server.sh

```bash
#!/bin/bash
# mcp-server/run_mcp_server.sh

# GS Codegen MCP Server Startup Script

# Get the directory of this script
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
cd $SCRIPT_DIR

clean_up() {
    echo "🧹 Cleaning up..."
	bash ./link_common_assets.sh unlink
}

# Always execute the function clean_up when the script is terminated
trap clean_up EXIT

copy_lib() {
    bash ./link_common_assets.sh link
}

# .env file read
if [ -f ../.env ]; then
    echo "🔍 Reading .env file..."
    set -o allexport; . ../.env; set +o allexport ;
else
    echo "❌ .env file not found. Please create one."
    exit 1
fi

echo "🥗 Starting GenericSuite CodeGen MCP Server..."
echo "📂 Server directory: $SCRIPT_DIR"

# Check if Python is available
if ! command -v python3 &> /dev/null; then
    if ! command -v python &> /dev/null; then
        echo "❌ Python not found. Please install Python 3.9 or later."
        exit 1
    else
        PYTHON_CMD="python"
    fi
else
    PYTHON_CMD="python3"
fi

echo "🐍 Using Python: $PYTHON_CMD"

# Check if requirements are installed
echo "📦 Checking dependencies..."
if ! poetry run python -c "import fastmcp" &> /dev/null; then
    echo "📥 Installing dependencies..."
    poetry install
    if [ $? -ne 0 ]; then
        echo "❌ Failed to install dependencies. Please check requirements.txt"
        exit 1
    fi
fi

echo "✅ Dependencies verified"
echo "🚀 Starting MCP server..."
echo ""

# Start the server

# Default values for environment variables

# Application stage (qa, stage, prod, demo) to run MCP server
if [ -z "$APP_STAGE" ]; then
    export APP_STAGE=qa
fi

# Debug mode
if [ -z "$MCP_INSPECTOR" ]; then
    export MCP_INSPECTOR="0"
fi

# MCP server port
if [ -z "$MCP_SERVER_PORT" ]; then
    export MCP_SERVER_PORT=8070
fi

# MCP server host
if [ -z "$MCP_SERVER_HOST" ]; then
    export MCP_SERVER_HOST=0.0.0.0
fi

STAGE_UPPERCASE=$(echo $APP_STAGE | tr '[:lower:]' '[:upper:]')
export APP_HOST_NAME="${APP_DOMAIN_NAME:-localhost}"
export APP_DB_ENGINE=$(eval echo \$APP_DB_ENGINE_${STAGE_UPPERCASE})
export APP_DB_NAME=$(eval echo \$APP_DB_NAME_${STAGE_UPPERCASE})
if [[ "${GET_SECRETS_ENABLED}" = "0" || "${GET_SECRETS_CRITICAL}" = "0" ]]; then
    export APP_DB_URI=$(eval echo \$APP_DB_URI_${STAGE_UPPERCASE})
else
    export APP_DB_URI=""
fi
export APP_CORS_ORIGIN="$(eval echo \"\$APP_CORS_ORIGIN_${STAGE_UPPERCASE}\")"
export AWS_S3_CHATBOT_ATTACHMENTS_BUCKET=$(eval echo \$AWS_S3_CHATBOT_ATTACHMENTS_BUCKET_${STAGE_UPPERCASE})

POETRY_ARGS="APP_STAGE=$APP_STAGE MCP_SERVER_PORT=$MCP_SERVER_PORT MCP_SERVER_HOST=$MCP_SERVER_HOST APP_DB_ENGINE=$APP_DB_ENGINE APP_DB_NAME=$APP_DB_NAME APP_CORS_ORIGIN=$APP_CORS_ORIGIN AWS_S3_CHATBOT_ATTACHMENTS_BUCKET=$AWS_S3_CHATBOT_ATTACHMENTS_BUCKET APP_HOST_NAME=$APP_HOST_NAME"

if [ "${GS_API_KEY}" != '' ]; then
    POETRY_ARGS="${POETRY_ARGS} GS_API_KEY=${GS_API_KEY}"
fi

copy_lib

if [ "$MCP_INSPECTOR" = "1" ]; then
    npx @modelcontextprotocol/inspector \
        poetry \
        run \
        env $POETRY_ARGS $PYTHON_CMD mcp_server.py
else
    poetry run env $POETRY_ARGS $PYTHON_CMD mcp_server.py
fi
```

#### mcp-server/link_common_assets.sh

```bash
#!/bin/sh
# scripts/link_common_assets.sh
# Link common files, directories and libraries for the MCP Server

copy_common_assets() {
    common_asset_source_name="$1"
    common_asset_target_name="$2"
    echo ""
    echo "Copying '$common_asset_source_name' to '$common_asset_target_name'"
    if ! cp -r "${BASE_DIR}/$common_asset_source_name" "${BASE_DIR}/$common_asset_target_name"
    then
        echo "ERROR: Could not copy '$common_asset_source_name' to '$common_asset_target_name'"
    fi
}

link_common_assets() {
    common_asset_source_name="$1"
    common_asset_target_name="$2"
    echo ""
    echo "Linking '$common_asset_source_name' to '$common_asset_target_name'"
    if ! ln -s "${BASE_DIR}/$common_asset_source_name/" "${BASE_DIR}/$common_asset_target_name/"
    then
        echo "ERROR: Could not link '$common_asset_source_name' to '$common_asset_target_name'"
    fi
}

unlink_common_assets() {
    common_asset_source_name="$1"
    common_asset_target_name="$2"

    echo ""
    echo "Unlinking '$common_asset_source_name' from '$common_asset_target_name'"

    if ! unlink "${BASE_DIR}/$common_asset_target_name/$common_asset_source_name"
    then
        echo "ERROR: Could not unlink '${BASE_DIR}/$common_asset_target_name/$common_asset_source_name'"
    fi
}

remove_common_assets() {
    common_asset_source_name="$1"
    echo ""
    echo "Removing '$common_asset_source_name'"
    if ! rm -rf "${BASE_DIR}/$common_asset_source_name"
    then
        echo "ERROR: Could not remove '${BASE_DIR}/$common_asset_source_name'"
    fi
}

BASE_DIR="`pwd`"
cd "`dirname "$0"`" ;
SCRIPTS_DIR="`pwd`" ;
cd "${BASE_DIR}"

ACTION="$1"

COPY_OR_SYMLINK="$2"
if [ "$COPY_OR_SYMLINK" = "" ]; then
    COPY_OR_SYMLINK="copy"
    # COPY_OR_SYMLINK="symlink"
fi

echo ""
echo "link_common_assets.sh"
echo "BASE_DIR: $BASE_DIR"
echo "SCRIPTS_DIR: $SCRIPTS_DIR"
echo "ACTION: $ACTION"
echo "COPY_OR_SYMLINK: $COPY_OR_SYMLINK"
echo ""

if [ "$ACTION" = "link" ]; then
    echo ""
    echo "link_common_assets.sh | Linking common assets..."
    copy_common_assets "../server/genericsuite_codegen" "./genericsuite_codegen"
elif [ "$ACTION" = "unlink" ]; then
    echo ""
    echo "link_common_assets.sh | Unlinking common assets..."
    remove_common_assets "./genericsuite_codegen"
else
    echo ""
    echo "ERROR: Unknown action: '$ACTION'"
    echo ""
    exit 1
fi
```

#### mcp-server/mcp_server.py

```python
#!/usr/bin/env python3
"""
MCP Server Template
A Model Context Protocol server that exposes the GenericSuite CodeGen API.
Based on the server/genericsuite_codegen/api/main.py
"""
import os
import json
from typing import Dict, Any

# For MCP Server
from fastmcp import FastMCP

from genericsuite_codegen.api.endpoint_methods import (
    ...
)

from genericsuite_codegen.api.utilities import (
    get_standard_response,
    log_info,
    get_non_empty_value,
)
from genericsuite_codegen.api.types import (
    ...
)


class MCPServerApp:
    def __init__(self, app_name: str):
        self.mcp = FastMCP(app_name)
        self.authenticated = False

    def get_authenticated(self):
        return self.authenticated

    def authenticate(self, api_key: str) -> dict[str, Any]:
        login_result: dict = authentication_tool(api_key)
        if login_result["error"]:
            return login_result
        self.authenticated = True
        return login_result


DEBUG = os.environ.get("SERVER_DEBUG", "0") == "1"

MCP_HTTP_TRANSPORT = get_non_empty_value("MCP_HTTP_TRANSPORT", "1") == "1"
MCP_SERVER_HOST = get_non_empty_value("MCP_SERVER_HOST", "0.0.0.0")
try:
    MCP_SERVER_PORT = int(get_non_empty_value("MCP_SERVER_PORT", "8070"))
except ValueError:
    raise ValueError("MCP_SERVER_PORT must be an integer.")

DEFAULT_JSON_INDENT = 2


# Initialize FastMCP server
cac_object_list = []
app = MCPServerApp(app_name="abstractgo-mcp-server")
mcp = app.mcp


# ============================================================================
# UTILITIES
# ============================================================================


def tool_result(result: str, other_data: dict = None) -> Dict[str, Any]:
    """
    Helper function to format tool results
    """
    if not other_data:
        other_data = {}
    error = "error" in result.lower()
    return {
        **other_data,
        "success": not error,
        "error": result if error else None,
        "message": None if error else result
    }


def resource_result(result: str, mime_type: str = "text/plain") -> str:
    """
    Helper function to format resource results
    """
    if result["error"]:
        return json.dumps(result, indent=DEFAULT_JSON_INDENT)
    if mime_type == "application/json":
        return result["resultset"]
    return json.dumps(result["resultset"], indent=DEFAULT_JSON_INDENT)


def mcp_authenticate(
    api_key: str,
) -> str:
    """
    Authenticate user with API key
    """
    login_result: dict = app.authenticate(api_key)
    if login_result["error"]:
        return tool_result(login_result["error_message"])
    result = get_standard_response(
        message="User logged in successfully",
        resultset=login_result["resultset"],
    )
    return resource_result(result, mime_type="application/json")


# ============================================================================
# MCP TOOLS - USER AUTHENTICATION
# ============================================================================


@mcp.tool()
async def get_api_keys() -> Dict[str, Any]:
    """
    Get API keys
    """
    log_info("Getting API keys")
    result = {
        "resultset": {
            "AG_API_KEY": os.environ.get("AG_API_KEY")
        }
    }
    return result


@mcp.tool()
async def mcp_authentication_tool(
    api_key: str,
) -> str:
    """
    Authenticate user
    """
    log_info("Authenticating user")
    return mcp_authenticate(api_key)


# ============================================================================
# MCP TOOLS - API INTEGRATION
# ============================================================================


# Define the tools here...


# ============================================================================
# MCP RESOURCES - DATA ACCESS
# ============================================================================


@mcp.resource("user://login/{api_key}",
              mime_type="application/json")
async def authenticate(
    api_key: str,
) -> str:
    """
    Get user login as a resource
    """
    log_info("Getting user login for resource")
    return mcp_authenticate(api_key)

# Define the rest of the resources here...


# ============================================================================
# SERVER STARTUP AND CONFIGURATION
# ============================================================================


def main():
    """
    Main entry point for the MCP Server
    """

    print("🥗 Starting GenericSuite codeGen MCP Server...")

    # Run the FastMCP server
    mcp_run_args = {
        "host": MCP_SERVER_HOST,
        "port": MCP_SERVER_PORT
    }
    if MCP_HTTP_TRANSPORT:
        mcp_run_args["transport"] = "http"
    print(f"\n🔧 Transport: {mcp_run_args['transport'].upper()}")
    print("💡 Connect via Claude Desktop, VS Code, or other MCP clients")
    print("\n✅ Server ready for connections!")

    if DEBUG:
        print("\n🔍 Debug mode enabled")
        print(f"MCP Server Config: {mcp_run_args}")
    mcp.run(**mcp_run_args)


main()
```

### Files for "ui" directory

#### ui/Makefile

```
.PHONY: install build dev start clean test lint preview

# Show help
help:
	@echo "Available commands:"
	@echo "  install       - Install npm dependencies"
	@echo "  build         - Build for production"
	@echo "  dev           - Run client in development mode"
	@echo "  start         - Alias for dev command"
	@echo "  preview       - Preview production build"
	@echo "  clean         - Remove node_modules, package-lock.json, and dist"
	@echo "  reinstall     - Clean and reinstall dependencies"
	@echo "  build-preview - Build and preview production version"
	@echo "  test          - Run tests"
	@echo "  lint          - Run linter"
	@echo "  help          - Show this help message"

# Install dependencies
install:
	npm install

# Build for production
build:
	bash ./run-client.sh build

# Run in development mode
dev:
	bash ./run-client.sh run

# Alias for dev (common pattern)
start: dev
run: dev

# Preview production build
preview:
	bash ./run-client.sh preview

# Clean node_modules, package-lock.json, and dist
clean:
	rm -rf node_modules package-lock.json dist

# Reinstall dependencies
reinstall: clean install

# Run tests (when implemented)
test:
	npm test

# Run linter (when implemented)
lint:
	npm run lint

# Build and preview
build-preview: build preview
```

#### ui/package.json

```json
{
  "name": "client",
  "private": true,
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "build": "vite build",
    "dev": "vite dev",
    "lint": "vite lint",
    "start": "vite start",
    "preview": "vite preview",
    "start:from_root": "bash ./run-client.sh run",
    "build:from_root": "bash ./run-client.sh build",
    "preview:from_root": "bash ./run-client.sh preview",
    "clean": "rm -rf node_modules",
    "client:install": "npm install --force"
  },
  "dependencies": {
    "@radix-ui/react-dialog": "^1.1.11",
    "@radix-ui/react-select": "^2.2.2",
    "@radix-ui/react-slot": "^1.2.0",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "genericsuite": "github:tomkat-cr/genericsuite-fe#develop",
    "genericsuite-ai": "github:tomkat-cr/genericsuite-fe-ai#develop",
    "handlebars": "^4.7.8",
    "lucide-react": "^0.507.0",
    "quagga": "^0.12.1",
    "tailwind-merge": "^3.2.0"
  },
  "devDependencies": {
    "@babel/cli": "^7.24.5",
    "@babel/core": "^7.24.5",
    "@babel/plugin-proposal-class-properties": "^7.18.6",
    "@babel/plugin-proposal-private-property-in-object": "^7.21.11",
    "@babel/plugin-syntax-jsx": "^7.24.1",
    "@babel/preset-env": "^7.24.5",
    "@babel/preset-react": "^7.24.1",
    "@babel/preset-stage-0": "^7.8.3",
    "@babel/preset-typescript": "^7.24.1",
    "@tailwindcss/vite": "^4.1.11",
    "@testing-library/jest-dom": "^5.17.0",
    "@testing-library/react": "^13.4.0",
    "@testing-library/user-event": "^13.5.0",
    "@types/jest": "^29.5.12",
    "@types/node": "^22.15.3",
    "@types/react": "^18.3.2",
    "@vitejs/plugin-react": "^4.6.0",
    "autoprefixer": "^10.4.19",
    "babel-jest": "^29.7.0",
    "babel-loader": "^9.1.3",
    "babel-plugin-css-modules-transform": "^1.6.2",
    "css-loader": "^7.1.1",
    "file-loader": "^6.2.0",
    "jest": "^29.7.0",
    "jest-environment-jsdom": "^29.7.0",
    "path": "^0.12.7",
    "postcss": "^8.4.38",
    "postcss-loader": "^8.1.1",
    "react-error-overlay": "^6.0.9",
    "react-test-renderer": "^18.3.1",
    "style-loader": "^4.0.0",
    "tailwindcss": "^4.1.5",
    "tw-animate-css": "^1.2.9",
    "url-loader": "^4.1.1",
    "vite": "^5.4.19",
    "vite-plugin-require": "^1.2.14",
    "whatwg-fetch": "^3.6.20"
  }
}
```

#### ui/run-client.sh

```bash
#!/bin/bash
# run-client.sh
#

# Script directory
SCRIPT_DIR=$(cd $(dirname $0); pwd)

if [ ! -f ../.env ]; then
    echo "Error: ../.env file not found in 'client' directory"
    exit 1
fi

echo "Loading environment variables from ../.env"
set -o allexport; . ../.env; set +o allexport ;

ACTION=$1

if [ -z "$ACTION" ]; then
    echo "Error: No action specified"
    exit 1
fi

if [ "$ACTION" = "run" ]; then
    echo "Starting client in development mode..."
    npm run dev
elif [ "$ACTION" == "build" ]; then
    echo "Building client..."
    npm run build
elif [ "$ACTION" == "preview" ]; then
    echo "Previewing production build..."
    npm run preview
else
    echo "Error: Invalid action specified: $ACTION"
    exit 1
fi
```

## References

- **MongoDB MCP server**: https://github.com/mongodb-js/mongodb-mcp-server
- **MongoDB Vector Search With MongoDB and OpenAI**: https://www.mongodb.com/developer/products/atlas/quickstart-vectorsearch-mongodb-python/
- **Brave MCP server**: https://github.com/brave/brave-search-mcp-server
- **Use Brave MCP server with Claude**: https://brave.com/search/api/guides/use-with-claude-desktop-with-mcp/
- **Context7 MCP server**: https://github.com/upstash/context7
- **Hugging Face Embeddings Leaderboard**: https://huggingface.co/spaces/mteb/leaderboard
- **Getting Started With Embeddings**: https://huggingface.co/blog/getting-started-with-embeddings
- **Advanced RAG on Hugging Face documentation using LangChain**: https://huggingface.co/learn/cookbook/advanced_rag
- **How to use Hugging Face free embedding models**: https://discuss.huggingface.co/t/how-to-use-huggingface-free-embedding-models/109700

## Embedding Models

- **Hugging Face thenlper/gte-small**: https://huggingface.co/thenlper/gte-small
- **Hugging Face sentence-transformers/all-MiniLM-L6-v2**: https://huggingface.co/sentence-transformers/all-MiniLM-L6-v2
- **OpenAI text-embedding-3-small**: https://platform.openai.com/docs/guides/embeddings/
